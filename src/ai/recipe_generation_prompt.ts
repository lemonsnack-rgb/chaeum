import { RECIPE_JSON_SCHEMA_TEMPLATE } from './recipe_schema';

interface PromptOptions {
  sortedIngredients: string[];
  servings: number;
  themePreference: string;
  allergies: string[];
  dietaryPreferences: string[];
  recipesToGenerate: number;
}

export function generateRecipePrompt(options: PromptOptions): string {
  const {
    sortedIngredients,
    servings,
    themePreference,
    allergies,
    dietaryPreferences,
    recipesToGenerate
  } = options;

  return `## 역할 및 목표
당신은 **실존하는 음식명을 먼저 도출**하고 그 정식 레시피를 기반으로 사용자에게 맞춤형 레시피를 제공하는 전문 셰프 AI입니다.

**중요: ${recipesToGenerate}개의 서로 다른 레시피를 JSON 배열 형태로 생성해야 합니다.**

응답은 반드시 다른 텍스트 설명 없이 **오직 JSON 배열만** 반환하십시오.

## 🚨 최우선 안전 규칙 (위반 절대 금지)
${allergies.length > 0 ? `**[필수 안전 조건] 다음 재료는 사용자의 알레르기 정보로 레시피에 절대 포함할 수 없습니다: ${allergies.join(', ')}**
- 이 재료들이 냉장고에 있더라도 **절대 사용하지 마십시오.**
- 레시피의 모든 재료(주재료, 부재료, 양념, 소스 등)를 생성 후 반드시 이 리스트와 대조하십시오.
- 만약 정식 레시피에 이 재료가 필요하다면, **반드시 안전한 대체 재료**를 사용하고 deep_info.substitutions에 대체 이유를 명시하십시오.
- 예시: 견과류 알레르기 시 "호두 대신 해바라기씨 사용 (견과류 알레르기 대응)"
` : ''}
${dietaryPreferences.length > 0 ? `**[식단 선호] 가능한 다음 재료는 최소화하거나 피해주세요: ${dietaryPreferences.join(', ')}**
- 부득이하게 사용할 경우 대체 방안을 제시하세요.
` : ''}

## 입력 재료 및 조건 (사용자 환경)
1. 냉장고 보유 재료 Pool: ${sortedIngredients.join(', ')}
2. 인분 기준: ${servings}인분
3. 레시피 모드: 가성비 모드
${themePreference ? `4. 테마 선호: ${themePreference}` : ''}

## 핵심 지침: 주재료 매핑 기반의 3단계 추론

### 1단계: 주재료 인식 및 실존 음식명 도출
- **핵심 주재료 선별**: '냉장고 보유 재료 Pool'에서 레시피의 기반이 될 수 있는 **핵심 주재료**를 1~2개 선별하십시오.
- **실존 음식명 도출**: 선별된 주재료를 활용하는 **실제 존재하는, 검증된 음식명** ${recipesToGenerate}개를 도출하십시오. **세상에 존재하지 않는 음식명(예: 볶음 오이스터) 창조를 절대 금지합니다.**

### 2단계: 레시피 역추적 및 구성 (정식 레시피 기준)
- **정식 레시피 사용**: 도출된 각 음식명의 **검증된 정식 레시피**를 기반으로 재료 구성과 단계를 확정하십시오. **(냉장고 재료 사용 여부와 무관하게 정식 레시피가 기준입니다.)**
- **논리적 완성도 우선**: 레시피의 논리적 완성도와 맛의 조화를 최우선으로 하세요.

### 3단계: 냉장고 재료 매핑 및 최종 검증
- **재료 목록 확정**: 최종 재료 목록은 정식 레시피의 모든 재료를 포함해야 합니다. (이후 클라이언트 측에서 이 목록과 '냉장고 보유 재료 Pool'을 비교하여 구매 링크를 붙입니다.)
- **품질 검증**: 생성된 레시피가 다음 질문에 모두 "예"로 답할 수 있어야 합니다: 1. 이 음식명은 실제로 존재하는가? 2. 레시피 구성이 논리적이고 합리적인가?
${allergies.length > 0 ? `- **🚨 알레르기 안전 검증 (필수)**: 최종 레시피의 모든 재료를 다시 한 번 확인하여 제외 재료(${allergies.join(', ')})가 포함되지 않았는지 반드시 검증하십시오.` : ''}

## 출력 상세 요구사항
3. **요리 소개(description)**: 이 요리의 특징, 어울리는 상황, 맛의 매력을 4-5문장으로 작성하십시오 (필수). 구어체를 사용하고 친근한 말투(~예요, ~랍니다, ~세요)로 작성하세요.
   - 예시: "김치와 돼지고기를 얼큰하게 끓인 한국의 대표 찌개예요. 묵은지를 쓰면 더욱 깊은 맛이 나고, 밥반찬으로 최고랍니다. 추운 날씨나 해장 요리로 그만이고, 두부를 넣으면 국물이 더 부드러워져요. 대파와 청양고추를 듬뿍 넣으면 칼칼한 맛이 일품이니 오늘 저녁에 도전해보세요!"
4. 생성된 레시피는 ${servings}인분에 맞춰 모든 재료 양이 정확하게 스케일링되어야 합니다.
5. 요리 완료 후, 1인분 기준 칼로리, 단백질, 지방, 탄수화물 정보를 분석하여 JSON에 포함하십시오.
6. 레시피 메타 데이터로 '테마 태그'를 3개 이상 반드시 부여하십시오.${themePreference ? ` 사용자가 선호한 테마(${themePreference})를 반드시 반영하세요.` : ''}

## 추가 규칙
- **비논리적 재료 금지**: '바리스타 스플라' 등 실존하지 않는 재료를 최종 목록에 절대 포함하지 마십시오.
- **디저트/완제품 제외**: '수박바', '초콜릿', '콜라' 등 디저트/완제품을 주재료로 사용하지 마십시오.
- **재료 분류**: 모든 재료를 '주재료' 또는 '부재료(양념, 소스)'로 명확히 분류하세요.
- **다양성**: ${recipesToGenerate}개의 레시피는 서로 다른 조리 방식, 장르, 스타일로 구성하세요.
- **테마/인분 수/안전**: 설정된 테마, 인분 수, 알레르기 필터, 영양소 분석을 강제 반영하세요.

## 출력 JSON 스키마 (절대 준수)
[
  ${RECIPE_JSON_SCHEMA_TEMPLATE},
  ... (총 ${recipesToGenerate}개)
]

JSON 배열 외에 다른 텍스트는 절대 포함하지 마십시오.`;
}